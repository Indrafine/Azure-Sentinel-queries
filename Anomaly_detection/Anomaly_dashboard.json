{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<h1>All Anomalies Detection  </h1>"
            },
            "name": "text - 3"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "list",
              "links": [
                {
                  "id": "e655ee3b-7a2b-4c3b-b5ce-71e95838ad25",
                  "cellValue": "",
                  "linkTarget": "Url",
                  "linkLabel": "Click Here to Add Analysis",
                  "style": "link"
                }
              ]
            },
            "name": "links - 3"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let startdate = 31d;\r\nlet enddate = 1d;\r\nAnomalies\r\n| where TimeGenerated > ago(enddate)\r\n| summarize TodayCnt=count() by AnomalyTemplateName\r\n| join (Anomalies\r\n| where TimeGenerated > ago(startdate) and TimeGenerated < ago(enddate)\r\n| summarize  count() by bin(TimeGenerated, 1d), AnomalyTemplateName\r\n| summarize Maxcount=max(count_), Mincount= min(count_), avg(count_) by AnomalyTemplateName\r\n| extend AvgCnt = round(avg_count_,0)\r\n) on AnomalyTemplateName\r\n| extend AnomalyDetection =  case((TodayCnt > (2* AvgCnt) and Maxcount < TodayCnt), \"Spike Detected\", ((2*TodayCnt) <AvgCnt and Mincount>TodayCnt),  \"Drop Detected\",\"No Detection\")\r\n| project AnomalyTemplateName,AnomalyDetection,TodayCnt, AvgCnt, Maxcount,Mincount",
              "size": 0,
              "showAnalytics": true,
              "title": "Anomaly Rule Spike and Drop Detection (based on 30 days data)",
              "exportFieldName": "AnomalyTemplateName",
              "exportParameterName": "Template",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Maxcount",
                    "formatter": 0,
                    "tooltipFormat": {
                      "tooltip": "{TimeGenerated}"
                    }
                  },
                  {
                    "columnMatch": "AnomalyDetection",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "Drop Detected",
                          "representation": "yellow",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Spike Detected",
                          "representation": "orange",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "No Detection",
                          "representation": "gray",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "blue",
                          "text": "{0}{1}"
                        }
                      ]
                    }
                  }
                ],
                "sortBy": [
                  {
                    "itemKey": "$gen_thresholds_AnomalyDetection_1",
                    "sortOrder": 2
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "$gen_thresholds_AnomalyDetection_1",
                  "sortOrder": 2
                }
              ]
            },
            "customWidth": "60",
            "name": "query - 6",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Anomaly Detection Trend",
              "items": [
                {
                  "type": 9,
                  "content": {
                    "version": "KqlParameterItem/1.0",
                    "parameters": [
                      {
                        "id": "a77334ac-122d-43c5-93fe-9f62e353fc72",
                        "version": "KqlParameterItem/1.0",
                        "name": "TimeSpan",
                        "type": 4,
                        "value": {
                          "durationMs": 2592000000
                        },
                        "typeSettings": {
                          "selectableValues": [
                            {
                              "durationMs": 300000
                            },
                            {
                              "durationMs": 900000
                            },
                            {
                              "durationMs": 1800000
                            },
                            {
                              "durationMs": 3600000
                            },
                            {
                              "durationMs": 14400000
                            },
                            {
                              "durationMs": 43200000
                            },
                            {
                              "durationMs": 86400000
                            },
                            {
                              "durationMs": 172800000
                            },
                            {
                              "durationMs": 259200000
                            },
                            {
                              "durationMs": 604800000
                            },
                            {
                              "durationMs": 1209600000
                            },
                            {
                              "durationMs": 2419200000
                            },
                            {
                              "durationMs": 2592000000
                            },
                            {
                              "durationMs": 5184000000
                            },
                            {
                              "durationMs": 7776000000
                            }
                          ],
                          "allowCustom": true
                        },
                        "timeContext": {
                          "durationMs": 86400000
                        }
                      }
                    ],
                    "style": "pills",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces"
                  },
                  "customWidth": "30",
                  "name": "parameters - 0"
                },
                {
                  "type": 1,
                  "content": {
                    "json": "<h3> {Template} </h3>"
                  },
                  "customWidth": "70",
                  "name": "text - 2"
                },
                {
                  "type": 3,
                  "content": {
                    "version": "KqlItem/1.0",
                    "query": "Anomalies\r\n| where AnomalyTemplateName == '{Template}'\r\n| summarize count() by bin(TimeGenerated, 1d)",
                    "size": 0,
                    "aggregation": 2,
                    "showAnalytics": true,
                    "timeContextFromParameter": "TimeSpan",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces",
                    "visualization": "timechart"
                  },
                  "name": "query - 1"
                }
              ]
            },
            "customWidth": "40",
            "name": "group - 5",
            "styleSettings": {
              "showBorder": true
            }
          }
        ]
      },
      "name": "group - 10",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<h1> Attempted Bruteforce Anomalies Detection </h1>\r\n----------------------------"
            },
            "customWidth": "100",
            "name": "text - 4"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "list",
              "links": [
                {
                  "id": "c7024e17-a0ca-478c-b782-a6e371d995d9",
                  "cellValue": "https://ts.accenture.com/sites/KDC-NA-KDC-NA-1C/_layouts/15/Doc.aspx?sourcedoc={2c430dc7-b9f8-4450-b24b-640987775a9e}&action=edit&wd=target%28Attempted%20Bruteforce%20Anomalies%20Detection.one%7Cfc32460f-c010-475f-9c1d-55739c1e96a3%2F%29&wdorigin=717",
                  "linkTarget": "Url",
                  "linkLabel": "Click Here to Add Analysis",
                  "style": "link"
                }
              ]
            },
            "customWidth": "70",
            "name": "links - 10"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "list",
              "links": [
                {
                  "id": "342ae019-e319-4359-b5ec-b74ea599fd81",
                  "cellValue": "",
                  "linkTarget": "Url",
                  "linkLabel": "Documentation",
                  "style": "link",
                  "icon": "1",
                  "linkIsContextBlade": true
                }
              ]
            },
            "customWidth": "20",
            "name": "links - 12",
            "styleSettings": {
              "padding": "20px"
            }
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "3cf3fae8-fbdb-428e-87ae-ccf21d30fb0c",
                  "version": "KqlParameterItem/1.0",
                  "name": "Timerange",
                  "type": 4,
                  "value": {
                    "durationMs": 259200000
                  },
                  "typeSettings": {
                    "selectableValues": [
                      {
                        "durationMs": 300000
                      },
                      {
                        "durationMs": 900000
                      },
                      {
                        "durationMs": 1800000
                      },
                      {
                        "durationMs": 3600000
                      },
                      {
                        "durationMs": 14400000
                      },
                      {
                        "durationMs": 43200000
                      },
                      {
                        "durationMs": 86400000
                      },
                      {
                        "durationMs": 172800000
                      },
                      {
                        "durationMs": 259200000
                      },
                      {
                        "durationMs": 604800000
                      },
                      {
                        "durationMs": 1209600000
                      },
                      {
                        "durationMs": 2419200000
                      },
                      {
                        "durationMs": 2592000000
                      },
                      {
                        "durationMs": 5184000000
                      },
                      {
                        "durationMs": 7776000000
                      }
                    ],
                    "allowCustom": true
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  }
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "parameters - 0"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Anomalies\r\n| where AnomalyTemplateName contains \"bruteforce\"\r\n| extend AbnormalFailedCount = tostring(AnomalyReasons[0].Value)\r\n| extend Historic_counts_ = tostring(parse_json(tostring(AnomalyReasons[0].TypicalObservations)).[\"Historic counts\"])\r\n| where isnotempty(UserName)\r\n|extend User= tostring(split(UserName,\"\\\\\").[1])\r\n| extend ExpectedCount = tostring(parse_json(tostring(parse_json(tostring(AnomalyDetails.Observables))[0].TypicalObservations)).[\"Expected count\"])\r\n| summarize by TimeGenerated, UserName, User, AbnormalFailedCount, ExpectedCount\r\n|join\r\n(SecurityEvent \r\n| summarize make_set(WorkstationName), make_set(IpAddress) by  Account)on $left.UserName== $right.Account\r\n| project TimeGenerated, UserName,AbnormalFailedCount,ExpectedCount,set_WorkstationName, set_IpAddress, User\r\n",
              "size": 1,
              "title": "User attempted bruteforce Anomalies Detected",
              "timeContextFromParameter": "Timerange",
              "exportedParameters": [
                {
                  "fieldName": "User",
                  "parameterName": "SelectedUser",
                  "defaultValue": ""
                },
                {
                  "fieldName": "UserName",
                  "parameterName": "SelectedUserName",
                  "parameterType": 1
                },
                {
                  "fieldName": "TimeGenerated",
                  "parameterName": "SelectedTimeGenerated",
                  "parameterType": 1
                },
                {
                  "fieldName": "ExpectedCount",
                  "parameterName": "SelectedExpectedCount",
                  "parameterType": 1
                },
                {
                  "fieldName": "Score",
                  "parameterName": "SelectedScore",
                  "parameterType": 1
                },
                {
                  "fieldName": "Historic_counts_",
                  "parameterName": "SelectedHistoricCount",
                  "parameterType": 1
                },
                {
                  "fieldName": "des1",
                  "parameterName": "Selecteddes1",
                  "parameterType": 1
                },
                {
                  "fieldName": "des2",
                  "parameterName": "Selecteddes2",
                  "parameterType": 1
                },
                {
                  "fieldName": "des3",
                  "parameterName": "Selecteddes3",
                  "parameterType": 1
                },
                {
                  "fieldName": "AbnormalFailedCount",
                  "parameterName": "SelectedAbnormalFailedCount",
                  "parameterType": 1
                }
              ],
              "showExportToExcel": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "UserName",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {
                          "operator": "contains",
                          "thresholdValue": "\\",
                          "representation": "gray",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": null,
                          "text": "{0}{1}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "AbnormalFailedCount",
                    "formatter": 8,
                    "formatOptions": {
                      "palette": "red"
                    }
                  },
                  {
                    "columnMatch": "User",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "Historic_counts_",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "Score",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "des1",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "des2",
                    "formatter": 5
                  },
                  {
                    "columnMatch": "des3",
                    "formatter": 5
                  }
                ],
                "sortBy": [
                  {
                    "itemKey": "$gen_heatmap_AbnormalFailedCount_2",
                    "sortOrder": 1
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "$gen_heatmap_AbnormalFailedCount_2",
                  "sortOrder": 1
                }
              ]
            },
            "name": "query - 1",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "c036e990-edac-4759-8716-3ffe3dafada7",
                  "version": "KqlParameterItem/1.0",
                  "name": "SetTime",
                  "type": 4,
                  "value": {
                    "durationMs": 1209600000
                  },
                  "typeSettings": {
                    "selectableValues": [
                      {
                        "durationMs": 300000
                      },
                      {
                        "durationMs": 900000
                      },
                      {
                        "durationMs": 1800000
                      },
                      {
                        "durationMs": 3600000
                      },
                      {
                        "durationMs": 14400000
                      },
                      {
                        "durationMs": 43200000
                      },
                      {
                        "durationMs": 86400000
                      },
                      {
                        "durationMs": 172800000
                      },
                      {
                        "durationMs": 259200000
                      },
                      {
                        "durationMs": 604800000
                      },
                      {
                        "durationMs": 1209600000
                      },
                      {
                        "durationMs": 2419200000
                      },
                      {
                        "durationMs": 2592000000
                      },
                      {
                        "durationMs": 5184000000
                      },
                      {
                        "durationMs": 7776000000
                      }
                    ],
                    "allowCustom": true
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  }
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "parameters - 8"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SecurityEvent\r\n| where EventID in (\"4625\", \"4624\")\r\n| where Account contains'{SelectedUser}'\r\n| summarize count() by bin(TimeGenerated, 1d), Activity\r\n//| summarize  count() by bin(TimeGenerated, 1d), Computer, Activity, IpAddress, WorkstationName, LogonTypeName, Account,TargetDomainName, TargetUserName, LogonProcessName, Status,SubStatus, FailureReason\r\n",
              "size": 0,
              "aggregation": 2,
              "showAnalytics": true,
              "title": " Authentication Failure &  Success Count Trend for User",
              "color": "green",
              "timeContextFromParameter": "SetTime",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "unstackedbar",
              "tileSettings": {
                "showBorder": false
              },
              "graphSettings": {
                "type": 0
              },
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "4624 - An account was successfully logged on.",
                    "color": "green"
                  },
                  {
                    "seriesName": "4625 - An account failed to log on.",
                    "color": "red"
                  }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - 2",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "SecurityEvent\r\n| where Account contains '{SelectedUser}' or TargetUserName contains '{SelectedUser}'\r\n| summarize count() by Activity, WorkstationName\r\n| order by count_ desc",
              "size": 0,
              "showAnalytics": true,
              "title": "All  Activities Detected for the User",
              "timeContextFromParameter": "SetTime",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "Activity",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "count_",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                },
                "showBorder": true,
                "size": "auto"
              }
            },
            "customWidth": "50",
            "name": "query - 7",
            "styleSettings": {
              "showBorder": true
            }
          }
        ]
      },
      "name": "group - 3",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 1,
      "content": {
        "json": "\r\n\r\n-------------------------------------------"
      },
      "name": "text - 3"
    },
    {
      "type": 1,
      "content": {
        "json": "-------------------------------------------"
      },
      "name": "text - 3 - Copy"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<h1> Palo Alto Anomalies Detection </h1>"
            },
            "name": "text - 0"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "list",
              "links": [
                {
                  "id": "e5a1aa14-a78c-4a73-a0d1-c68e53550068",
                  "cellValue": "https://ts.accenture.com/sites/KDC-NA-KDC-NA-1C/_layouts/15/Doc.aspx?sourcedoc={2c430dc7-b9f8-4450-b24b-640987775a9e}&action=edit&wd=target%28Palo%20Alto%20Anomalies%20Detection.one%7Cb8d2c75b-2a2d-488a-b9e2-cfe610414d5f%2F%29&wdorigin=717",
                  "linkTarget": "Url",
                  "linkLabel": "Click Here to Add Analysis",
                  "style": "link"
                }
              ]
            },
            "name": "links - 10"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "826208dd-ea29-43ab-b05f-a29b1eb21fdf",
                  "version": "KqlParameterItem/1.0",
                  "name": "TimeRange",
                  "type": 4,
                  "value": {
                    "durationMs": 604800000
                  },
                  "typeSettings": {
                    "selectableValues": [
                      {
                        "durationMs": 300000
                      },
                      {
                        "durationMs": 900000
                      },
                      {
                        "durationMs": 1800000
                      },
                      {
                        "durationMs": 3600000
                      },
                      {
                        "durationMs": 14400000
                      },
                      {
                        "durationMs": 43200000
                      },
                      {
                        "durationMs": 86400000
                      },
                      {
                        "durationMs": 172800000
                      },
                      {
                        "durationMs": 259200000
                      },
                      {
                        "durationMs": 604800000
                      },
                      {
                        "durationMs": 1209600000
                      },
                      {
                        "durationMs": 2419200000
                      },
                      {
                        "durationMs": 2592000000
                      },
                      {
                        "durationMs": 5184000000
                      },
                      {
                        "durationMs": 7776000000
                      }
                    ],
                    "allowCustom": true
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  }
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "parameters - 1"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "CommonSecurityLog\r\n| where DeviceProduct == \"PAN-OS\"\r\n| summarize count() by bin(TimeGenerated, 1h)",
              "size": 0,
              "title": "Hourly Palo Alto Log Trend",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "areachart"
            },
            "name": "query - 9",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "//let Deviceaction= dynamic([\"deny\",\"Blocked\",\"drop\",\"block-url\",\"drop-packet\",\"Drop\",\"IPS Drop\"]);\r\nlet startdate = 15d;\r\nlet enddate = 1d;\r\nCommonSecurityLog\r\n| where TimeGenerated > ago(enddate)\r\n| where DeviceProduct == \"PAN-OS\"\r\n//|where  DeviceAction in (Deviceaction)\r\n| summarize TodayCnt=count() by  DeviceAction\r\n| join (CommonSecurityLog\r\n| where TimeGenerated > ago(startdate) and TimeGenerated < ago(enddate)\r\n| where DeviceProduct == \"PAN-OS\"\r\n//|where  DeviceAction in (Deviceaction)\r\n| summarize  count() by bin(TimeGenerated, 1d), DeviceAction\r\n| summarize Maxcount=max(count_), Mincount= min(count_), AvgCnt= avg(count_) by DeviceAction\r\n| extend Avgcount = round(AvgCnt, 2)\r\n) on DeviceAction\r\n| extend AnomalyDetection = case(TodayCnt > Maxcount and TodayCnt- Avgcount>5 and TodayCnt > 2*Avgcount, \"Spike Detected\", TodayCnt < Mincount and TodayCnt < 0.5*Avgcount and Avgcount - TodayCnt> 5,  \"Drop Detected\",\"No Detection\")\r\n| project DeviceAction, TodayCnt, Avgcount,Maxcount, Mincount, AnomalyDetection\r\n",
              "size": 0,
              "showAnalytics": true,
              "exportFieldName": "DeviceAction",
              "exportParameterName": "Action",
              "exportDefaultValue": "deny",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "AnomalyRatio",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": ">=",
                          "thresholdValue": "2",
                          "representation": "trendup",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "<=",
                          "thresholdValue": "0.5",
                          "representation": "trenddown",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "Line",
                          "text": "{0}{1}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "AnomalyDetection",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {
                          "operator": "contains",
                          "thresholdValue": "Spike",
                          "representation": "red",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "contains",
                          "thresholdValue": "Drop",
                          "representation": "orange",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "gray",
                          "text": "{0}{1}"
                        }
                      ]
                    }
                  }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - 8",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "CommonSecurityLog\r\n| where DeviceProduct == \"PAN-OS\"\r\n| where isnotempty(DeviceAction)\r\n| where DeviceAction in (\"{Action}\")\r\n|summarize count() by bin(TimeGenerated, 1d)",
              "size": 0,
              "showAnalytics": true,
              "title": "Palo Alto Log Trend for Device Action : {Action:label}",
              "timeContextFromParameter": "TimeRange",
              "exportFieldName": "DeviceAction",
              "exportParameterName": "Action",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart"
            },
            "customWidth": "50",
            "name": "query - 1",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "CommonSecurityLog\r\n| where DeviceVendor contains \"palo\"\r\n| where isnotempty( IndicatorThreatType)\r\n| summarize count() by IndicatorThreatType, bin(TimeGenerated, 1h)\r\n\r\n",
              "size": 0,
              "aggregation": 2,
              "title": "PaloAlto Anomalies Detection by ThreatType",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "areachart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "Botnet",
                    "color": "grayBlue"
                  }
                ]
              }
            },
            "name": "query - 2",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "1b0cfd3c-708a-4349-b07e-64ab4f8a1dc0",
                  "version": "KqlParameterItem/1.0",
                  "name": "TimeSpan",
                  "type": 4,
                  "value": {
                    "durationMs": 86400000
                  },
                  "typeSettings": {
                    "selectableValues": [
                      {
                        "durationMs": 300000
                      },
                      {
                        "durationMs": 900000
                      },
                      {
                        "durationMs": 1800000
                      },
                      {
                        "durationMs": 3600000
                      },
                      {
                        "durationMs": 14400000
                      },
                      {
                        "durationMs": 43200000
                      },
                      {
                        "durationMs": 86400000
                      },
                      {
                        "durationMs": 172800000
                      },
                      {
                        "durationMs": 259200000
                      },
                      {
                        "durationMs": 604800000
                      },
                      {
                        "durationMs": 1209600000
                      },
                      {
                        "durationMs": 2419200000
                      },
                      {
                        "durationMs": 2592000000
                      },
                      {
                        "durationMs": 5184000000
                      },
                      {
                        "durationMs": 7776000000
                      }
                    ],
                    "allowCustom": true
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  }
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "parameters - 6"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "CommonSecurityLog\r\n| where DeviceVendor contains \"palo\"\r\n| where DeviceAction in (\"deny\", \"drop\", \"drop-packet\")\r\n| where isnotempty( IndicatorThreatType)\r\n| where DeviceCustomString4 == \"outside\"\r\n| summarize count() by MaliciousIP\r\n| order by count_ desc\r\n| take 5\r\n\r\n",
              "size": 0,
              "title": "Top Inbound Malicious IP Hits",
              "timeContextFromParameter": "TimeSpan",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "barchart"
            },
            "customWidth": "30",
            "name": "query - 6",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "CommonSecurityLog\r\n| where DeviceVendor contains \"palo\"\r\n| where DeviceAction in (\"deny\", \"drop\", \"drop-packet\")\r\n| where isnotempty( IndicatorThreatType)\r\n| where DeviceCustomString4 == \"outside\"\r\n| summarize count() by MaliciousIP, MaliciousIPCountry,  ThreatConfidence, IndicatorThreatType\r\n| order by count_ desc\r\n| take 5\r\n",
              "size": 0,
              "title": "TOP 10 Inbound malicious IP Details",
              "timeContextFromParameter": "TimeSpan",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "gridSettings": {
                "labelSettings": [
                  {
                    "columnId": "ThreatConfidence",
                    "label": "Score"
                  },
                  {
                    "columnId": "IndicatorThreatType",
                    "label": "Threat"
                  }
                ]
              }
            },
            "customWidth": "35",
            "name": "query - 7",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "CommonSecurityLog\r\n| where DeviceVendor contains \"palo\"\r\n| where DeviceAction in (\"deny\", \"drop\", \"drop-packet\")\r\n| where isnotempty( IndicatorThreatType)\r\n| where DeviceCustomString4 == \"outside\"\r\n| summarize count() by MaliciousIPCountry\r\n| order by count_ desc\r\n| take 20",
              "size": 0,
              "title": "Country Wise  Malicious IP Hits",
              "timeContextFromParameter": "TimeSpan",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "map",
              "mapSettings": {
                "locInfo": "CountryRegion",
                "locInfoColumn": "MaliciousIPCountry",
                "latitude": "MaliciousIPLatitude",
                "longitude": "MaliciousIPLongitude",
                "sizeSettings": "count_",
                "sizeAggregation": "Sum",
                "labelSettings": "MaliciousIPCountry",
                "legendMetric": "count_",
                "legendAggregation": "Sum",
                "itemColorSettings": {
                  "nodeColorField": "count_",
                  "colorAggregation": "Sum",
                  "type": "heatmap",
                  "heatmapPalette": "redGreen"
                }
              }
            },
            "customWidth": "35",
            "name": "query - 7",
            "styleSettings": {
              "showBorder": true
            }
          }
        ]
      },
      "name": "group - 1",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 1,
      "content": {
        "json": "\r\n-----------------------------"
      },
      "name": "text - 7"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<h1>Zscaler Anomalies Detection</h1>"
            },
            "name": "text - 0"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "list",
              "links": [
                {
                  "id": "a1b4c227-f686-4a33-b2de-6fa38164e894",
                  "cellValue": "https://ts.accenture.com/sites/KDC-NA-KDC-NA-1C/_layouts/15/Doc.aspx?sourcedoc={2c430dc7-b9f8-4450-b24b-640987775a9e}&action=edit&wd=target%28Zscaler%20Anomalies%20Detection.one%7Cc79d6075-ce20-4a50-9962-3d6b98159491%2F%29&wdorigin=717",
                  "linkTarget": "Url",
                  "linkLabel": "Click Here to Add Analysis",
                  "style": "link"
                }
              ]
            },
            "name": "links - 7"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "7415ff79-2e2f-4fa7-aded-ec145ef21425",
                  "version": "KqlParameterItem/1.0",
                  "name": "TimeRange",
                  "type": 4,
                  "value": {
                    "durationMs": 604800000
                  },
                  "typeSettings": {
                    "selectableValues": [
                      {
                        "durationMs": 300000
                      },
                      {
                        "durationMs": 900000
                      },
                      {
                        "durationMs": 1800000
                      },
                      {
                        "durationMs": 3600000
                      },
                      {
                        "durationMs": 14400000
                      },
                      {
                        "durationMs": 43200000
                      },
                      {
                        "durationMs": 86400000
                      },
                      {
                        "durationMs": 172800000
                      },
                      {
                        "durationMs": 259200000
                      },
                      {
                        "durationMs": 604800000
                      },
                      {
                        "durationMs": 1209600000
                      },
                      {
                        "durationMs": 2419200000
                      },
                      {
                        "durationMs": 2592000000
                      },
                      {
                        "durationMs": 5184000000
                      },
                      {
                        "durationMs": 7776000000
                      }
                    ],
                    "allowCustom": true
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  }
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "parameters - 5"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let startdate = 15d;\r\nlet enddate = 1d;\r\nCommonSecurityLog\r\n| where TimeGenerated > ago(enddate)\r\n| where DeviceVendor == \"Zscaler\"\r\n| where isnotempty(DestinationHostName)\r\n| summarize TodayCnt=count() by  URLCat=DeviceCustomString2\r\n| join (CommonSecurityLog\r\n| where TimeGenerated > ago(startdate) and TimeGenerated < ago(enddate)\r\n| where DeviceVendor == \"Zscaler\"\r\n//|where  DeviceAction in (Deviceaction)\r\n| summarize  count() by bin(TimeGenerated, 1d), URLCat=DeviceCustomString2\r\n| summarize Maxcount=max(count_), Mincount= min(count_), AvgCnt= avg(count_) by URLCat\r\n| extend Avgcount = round(AvgCnt, 0)\r\n) on URLCat\r\n| extend AnomalyDetection = case(TodayCnt > Maxcount and TodayCnt- Avgcount>5 and TodayCnt > 3*Avgcount, \"Spike Detected\", TodayCnt < Mincount and TodayCnt < 0.5*Avgcount and Avgcount - TodayCnt> 5,  \"Drop Detected\",\"No Detection\")\r\n| project URLCat, TodayCnt, Avgcount,Maxcount, Mincount, AnomalyDetection\r\n| sort by AnomalyDetection desc\r\n",
              "size": 0,
              "exportFieldName": "URLCat",
              "exportParameterName": "URLCategory",
              "exportDefaultValue": "Webmail",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "URLCat",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "35ch"
                    }
                  },
                  {
                    "columnMatch": "AnomalyDetection",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {
                          "operator": "contains",
                          "thresholdValue": "Spike",
                          "representation": "red",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "contains",
                          "thresholdValue": "Drop",
                          "representation": "orange",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "contains",
                          "thresholdValue": "No",
                          "representation": "gray",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "blue",
                          "text": "{0}{1}"
                        }
                      ]
                    }
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "URLCat",
                    "label": "URLCategory"
                  }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - 8",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "CommonSecurityLog\r\n| where DeviceVendor == \"Zscaler\"\r\n| where DeviceCustomString2 in ('{URLCategory}')\r\n| summarize count() by bin(TimeGenerated, 1d), DeviceAction",
              "size": 0,
              "title": "URL Category Trend : {URLCategory:label}",
              "timeContextFromParameter": "TimeRange",
              "exportFieldName": "URLcat",
              "exportParameterName": "URLCategory",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "areachart"
            },
            "customWidth": "50",
            "name": "query - 10",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "CommonSecurityLog\r\n| where DeviceVendor == \"Zscaler\"\r\n| where DeviceCustomString2 in ('{URLCategory}')\r\n| summarize count() by DestinationHostName\r\n| join  kind= leftouter ( \r\n_GetWatchlist('CrowdStrike_High_Domain') ) on $left.DestinationHostName == $right.indicator\r\n| project DestinationHostName,count_,malicious_confidence, malware_families\r\n|top 10 by count_",
              "size": 0,
              "showAnalytics": true,
              "title": "Top URL Detected ",
              "timeContextFromParameter": "TimeRange",
              "exportFieldName": "DestinationHostName",
              "exportParameterName": "Host",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "DestinationHostName",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "20ch"
                    }
                  }
                ],
                "sortBy": [
                  {
                    "itemKey": "count_",
                    "sortOrder": 2
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "DestinationHostName",
                    "label": "",
                    "comment": "Click here to get more about the domain"
                  },
                  {
                    "columnId": "malicious_confidence",
                    "label": "CS_Confidence"
                  },
                  {
                    "columnId": "malware_families",
                    "label": "CS_ThreatFamily"
                  }
                ]
              },
              "sortBy": [
                {
                  "itemKey": "count_",
                  "sortOrder": 2
                }
              ]
            },
            "customWidth": "35",
            "name": "query - 9",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "bullets",
              "links": [
                {
                  "id": "22e9ecee-cc5d-4d27-a33a-3bbac3414d5c",
                  "cellValue": "https://www.virustotal.com/gui/domain/{Host}",
                  "linkTarget": "Url",
                  "linkLabel": "VirusTotal  Domain  Check",
                  "preText": "",
                  "style": "link"
                }
              ]
            },
            "customWidth": "15",
            "name": "links - 7",
            "styleSettings": {
              "margin": "32px",
              "padding": "32px"
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "CommonSecurityLog\r\n| where DeviceVendor == \"Zscaler\"\r\n| where DestinationHostName in ('{Host}')\r\n| summarize count() by bin(TimeGenerated,1d), DeviceAction",
              "size": 0,
              "showAnalytics": true,
              "title": "Detected URL Trend",
              "color": "orange",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "linechart"
            },
            "customWidth": "50",
            "name": "query - 12",
            "styleSettings": {
              "showBorder": true
            }
          }
        ]
      },
      "name": "group - 6",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 1,
      "content": {
        "json": "-------------------------------"
      },
      "name": "text - 10"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<h1> Email Events Anomaly Detection </h1>"
            },
            "name": "text - 2"
          },
          {
            "type": 11,
            "content": {
              "version": "LinkItem/1.0",
              "style": "list",
              "links": [
                {
                  "id": "05da4f33-3e85-4299-b33f-d10efa4e1bcd",
                  "cellValue": "https://ts.accenture.com/sites/KDC-NA-KDC-NA-1C/_layouts/15/Doc.aspx?sourcedoc={2c430dc7-b9f8-4450-b24b-640987775a9e}&action=edit&wd=target%28Email%20Events%20Anomaly%20Detection.one%7C40676f36-177f-4827-a949-20156807dcb4%2F%29&wdorigin=717",
                  "linkTarget": "Url",
                  "linkLabel": "Click Here to Add Analysis",
                  "style": "link"
                }
              ]
            },
            "name": "links - 6"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "ee70bf00-b4ec-421d-86e4-ffc7688f978a",
                  "version": "KqlParameterItem/1.0",
                  "name": "TimeRange",
                  "type": 4,
                  "value": {
                    "durationMs": 1209600000
                  },
                  "typeSettings": {
                    "selectableValues": [
                      {
                        "durationMs": 300000
                      },
                      {
                        "durationMs": 900000
                      },
                      {
                        "durationMs": 1800000
                      },
                      {
                        "durationMs": 3600000
                      },
                      {
                        "durationMs": 14400000
                      },
                      {
                        "durationMs": 43200000
                      },
                      {
                        "durationMs": 86400000
                      },
                      {
                        "durationMs": 172800000
                      },
                      {
                        "durationMs": 259200000
                      },
                      {
                        "durationMs": 604800000
                      },
                      {
                        "durationMs": 1209600000
                      },
                      {
                        "durationMs": 2419200000
                      },
                      {
                        "durationMs": 2592000000
                      },
                      {
                        "durationMs": 5184000000
                      },
                      {
                        "durationMs": 7776000000
                      }
                    ],
                    "allowCustom": true
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  }
                }
              ],
              "style": "pills",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "parameters - 9"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let startdate = 15d;\r\nlet enddate = 1d;\r\nEmailEvents\r\n| where EmailDirection == \"Inbound\"\r\n| where TimeGenerated > ago(enddate)\r\n| summarize TodayCnt=count() by  DeliveryLocation\r\n| join (EmailEvents\r\n| where EmailDirection == \"Inbound\"\r\n| where TimeGenerated > ago(startdate) and TimeGenerated < ago(enddate)\r\n| summarize  count() by bin(TimeGenerated, 1d), DeliveryLocation\r\n| summarize Maxcount=max(count_), Mincount= min(count_), AvgCnt= avg(count_) by DeliveryLocation\r\n| extend Avgcount = round(AvgCnt, 0)\r\n) on DeliveryLocation\r\n| extend AnomalyDetection = case(TodayCnt > Maxcount and TodayCnt- Avgcount>20 and TodayCnt > 2*Avgcount, \"Spike Detected\", TodayCnt < Mincount and TodayCnt < 0.5*Avgcount and Avgcount - TodayCnt> 20,  \"Drop Detected\",\"No Detection\")\r\n| project DeliveryLocation, TodayCnt, Avgcount,Maxcount, Mincount, AnomalyDetection\r\n",
              "size": 0,
              "aggregation": 2,
              "title": "Inbound Email Delivery Location Anomalies Detection",
              "timeContextFromParameter": "TimeRange",
              "exportFieldName": "DeliveryLocation",
              "exportParameterName": "PickDeliveryLocation",
              "exportDefaultValue": "Inbox/folder",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "table",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "AnomalyDetection",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {
                          "operator": "contains",
                          "thresholdValue": "Spike",
                          "representation": "red",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "contains",
                          "thresholdValue": "Drop",
                          "representation": "orange",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "contains",
                          "thresholdValue": "No",
                          "representation": "gray",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "blue",
                          "text": "{0}{1}"
                        }
                      ]
                    }
                  }
                ]
              },
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "EmailDeliveryAction",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "count_",
                  "formatter": 12,
                  "formatOptions": {
                    "palette": "auto"
                  },
                  "numberFormat": {
                    "unit": 17,
                    "options": {
                      "maximumSignificantDigits": 3,
                      "maximumFractionDigits": 2
                    }
                  }
                },
                "showBorder": true,
                "size": "auto"
              }
            },
            "customWidth": "50",
            "name": "query - 9",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "EmailEvents\r\n| where EmailDirection == \"Inbound\"\r\n| where DeliveryLocation in ('{PickDeliveryLocation}')\r\n| summarize count() by bin(TimeGenerated, 1d), DeliveryAction",
              "size": 0,
              "aggregation": 2,
              "title": "{PickDeliveryLocation:label} : Email Delivery Location Trend",
              "timeContextFromParameter": "TimeRange",
              "exportFieldName": "DeliveryLocation",
              "exportParameterName": "PickDeliveryLocation",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "timechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "count_",
                    "color": "green"
                  }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - 3",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "EmailEvents\r\n| where EmailDirection == \"Inbound\"\r\n| where DeliveryLocation == '{PickDeliveryLocation}' \r\n| summarize RecipientCount=dcount(RecipientEmailAddress),SubjectCount=dcount(Subject),  TotalCount=count() by SenderFromAddress, DeliveryLocation, DeliveryAction\r\n| top 10 by TotalCount\r\n\r\n",
              "size": 0,
              "showAnalytics": true,
              "title": "Dellivery Action Wise TOP Sender Details for Inbound Email",
              "timeContextFromParameter": "TimeRange",
              "exportedParameters": [
                {
                  "fieldName": "SenderFromAddress",
                  "parameterName": "Sender"
                },
                {
                  "fieldName": "DeliveryLocation",
                  "parameterName": "PickDeliveryLocation",
                  "parameterType": 1
                }
              ],
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "SenderFromAddress",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "30ch"
                    }
                  },
                  {
                    "columnMatch": "DeliveryLocation",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "20ch"
                    }
                  },
                  {
                    "columnMatch": "DeliveryAction",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "18ch"
                    }
                  },
                  {
                    "columnMatch": "RecipientCount",
                    "formatter": 8,
                    "formatOptions": {
                      "palette": "yellow",
                      "customColumnWidthSetting": "15ch"
                    }
                  },
                  {
                    "columnMatch": "SubjectCount",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "13ch"
                    }
                  },
                  {
                    "columnMatch": "TotalCount",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "15ch"
                    }
                  }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - 4",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "EmailEvents\r\n| where EmailDirection == \"Inbound\"\r\n| where SenderFromAddress in ('{Sender}')\r\n| where DeliveryLocation in ('{PickDeliveryLocation}')\r\n| project SenderFromAddress, RecipientEmailAddress,Subject, DeliveryLocation, DeliveryAction, AttachmentCount, UserLevelPolicy",
              "size": 0,
              "showAnalytics": true,
              "title": "Selected User Log Details ",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "customWidth": "50",
            "name": "query - 6",
            "styleSettings": {
              "showBorder": true
            }
          }
        ]
      },
      "name": "group - 11",
      "styleSettings": {
        "showBorder": true
      }
    },
    {
      "type": 1,
      "content": {
        "json": "----------------------"
      },
      "name": "text - 9"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "<h1> Sentinel Incidents Spike and Detections </h1><h5>(shows 15 days trend)</h5>"
            },
            "name": "text - 3"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let timeframe= 15d;\r\nSecurityIncident\r\n| where Status == \"New\"\r\n|where TimeGenerated >= ago(timeframe)\r\n|summarize arg_max(TimeGenerated,*) by IncidentNumber\r\n|summarize  count() by bin(TimeGenerated,1d)",
              "size": 0,
              "aggregation": 2,
              "title": "Incident Spike in Sentinel",
              "color": "turquoise",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "barchart"
            },
            "customWidth": "60",
            "name": "query - 11",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let startdate = 15d;\r\nlet enddate = 1d;\r\nSecurityIncident\r\n| where TimeGenerated > ago(enddate)\r\n|where Status == \"New\"\r\n|summarize arg_max(TimeGenerated,*) by IncidentNumber\r\n|summarize TodayCnt=count() by Title\r\n| join (SecurityIncident\r\n| where TimeGenerated > ago(startdate) and TimeGenerated < ago(enddate)\r\n| where Status == \"New\"\r\n| summarize arg_max(TimeGenerated,*) by IncidentNumber\r\n| summarize  count() by bin(TimeGenerated, 1d), Title\r\n| summarize Maxcount=max(count_), Mincount= min(count_), AvgCnt= avg(count_) by Title\r\n| extend Avgcount = round(AvgCnt,2)\r\n) on Title\r\n| extend AnomalyDetection = case(TodayCnt > Maxcount and TodayCnt- Avgcount>5 and TodayCnt > 2*Avgcount, \"Spike Detected\", TodayCnt < Mincount and TodayCnt < 0.5*Avgcount and Avgcount - TodayCnt> 5,  \"Drop Detected\",\"No Detection\")\r\n| project Title, AnomalyDetection,TodayCnt, Avgcount, Maxcount, Mincount ",
              "size": 0,
              "title": "Sentinel  Incident Detection",
              "exportFieldName": "Title",
              "exportParameterName": "rulename",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "AnomalyDetection",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "colors",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "No Detection",
                          "representation": "gray",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Spike Detected",
                          "representation": "red",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Drop Detected",
                          "representation": "orange",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "blue",
                          "text": "{0}{1}"
                        }
                      ]
                    }
                  }
                ]
              }
            },
            "customWidth": "50",
            "name": "query - 12",
            "styleSettings": {
              "showBorder": true
            }
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let timeframe= 15d;\r\nSecurityIncident\r\n| where Status == \"New\"\r\n|where TimeGenerated >= ago(timeframe)\r\n|where Title == '{rulename}'\r\n|summarize arg_max(TimeGenerated,*) by IncidentNumber\r\n|summarize  count() by bin(TimeGenerated,1d)",
              "size": 0,
              "aggregation": 2,
              "title": "Incident Detection Trend",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "visualization": "linechart"
            },
            "customWidth": "50",
            "name": "query - 12",
            "styleSettings": {
              "showBorder": true
            }
          }
        ]
      },
      "name": "group - 13",
      "styleSettings": {
        "showBorder": true
      }
    }
  ],
  "fallbackResourceIds": [
    "/subscriptions/4eada9a4-398a-483e-bdf9-6eeba9185f22/resourcegroups/rg-cyber-sentinel-prod/providers/microsoft.operationalinsights/workspaces/ws-cyber-prod"
  ],
  "fromTemplateId": "sentinel-UserWorkbook",
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
